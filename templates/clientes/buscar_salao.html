{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Buscar SalÃ£o</title>

<link rel="stylesheet" href="{% static 'assets/css/cliente/buscar_salao.css' %}">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<link rel="stylesheet"
href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>

<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

</head>

<body>

<div class="container">

<div class="search-box">
<h2>ğŸ” Buscar SalÃ£o</h2>

<button onclick="toggleTheme()" style="
padding:10px 18px;
border-radius:10px;
border:none;
background:#6366f1;
color:white;
cursor:pointer;
margin-bottom:15px;
">
ğŸŒ™ Alternar tema
</button>

<form method="GET">
<input type="text" name="q" placeholder="Digite nome ou CEP">
<button type="submit">Buscar</button>
</form>
</div>

<div class="results">

{% for salao in saloes %}

<div class="card"
data-lat="{{ salao.latitude|default:'' }}"
data-lng="{{ salao.longitude|default:'' }}"
data-nome="{{ salao.nome }}"
data-rua="{{ salao.rua }}"
data-bairro="{{ salao.bairro }}">

<h3>{{ salao.nome }}</h3>

<p>{{ salao.rua }} - {{ salao.bairro }}</p>
<p><strong>CEP:</strong> {{ salao.cep }}</p>

<a class="btn-escolher"
href="{% url 'escolher_salao' salao.id %}">
âœ… Escolher este salÃ£o
</a>

</div>

{% empty %}
<p class="no-result">Nenhum salÃ£o encontrado.</p>
{% endfor %}

</div>

<!-- MAPA -->
<div id="map"></div>

</div>
<script>

function toggleTheme(){
    document.body.classList.toggle("dark");
}

document.addEventListener("DOMContentLoaded", function(){

    /* ================= MAPA ================= */

    const map = L.map("map");
    
    L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
            maxZoom:19,
            attribution:"Â© OpenStreetMap"
        }
    ).addTo(map);

    const cluster = L.markerClusterGroup();

    let markers = [];
    let firstLat = null;
    let firstLng = null;

    /* ================= SALÃ•ES ================= */

    document.querySelectorAll(".card").forEach((card,index)=>{

        const lat = parseFloat(card.dataset.lat);
        const lng = parseFloat(card.dataset.lng);

        if(isNaN(lat) || isNaN(lng)) return;

        if(firstLat === null){
            firstLat = lat;
            firstLng = lng;
        }

        const marker = L.marker([lat,lng]);

        marker.bindPopup(`
            <div style="min-width:200px">
                <strong>ğŸ’ˆ ${card.dataset.nome}</strong><br>
                ğŸ“ ${card.dataset.rua}<br>
                ğŸ™ï¸ ${card.dataset.bairro}
            </div>
        `);

        cluster.addLayer(marker);
        markers.push([lat,lng]);

        card.addEventListener("click",()=>{
            map.flyTo([lat,lng],17,{duration:1.5});
            setTimeout(()=>marker.openPopup(),400);
        });

    });

    map.addLayer(cluster);

    /* ================= AJUSTE AUTOMÃTICO DE VISÃƒO ================= */

    if(markers.length > 1){
        map.fitBounds(markers);
    }else if(firstLat !== null){
        map.setView([firstLat,firstLng],15);
    }else{
        map.setView([-14.2350,-51.9253],5);
    }

    /* ================= SUA LOCALIZAÃ‡ÃƒO ================= */

    if(navigator.geolocation){

        navigator.geolocation.getCurrentPosition(function(pos){

            const userLat = pos.coords.latitude;
            const userLng = pos.coords.longitude;

            const userMarker = L.circleMarker([userLat,userLng],{
                radius:10,
                fillColor:"#2563eb",
                color:"#ffffff",
                weight:3,
                fillOpacity:1
            }).addTo(map)
            .bindPopup("ğŸ“ VocÃª estÃ¡ aqui");

            /* animaÃ§Ã£o suave atÃ© vocÃª */
            map.flyTo([userLat,userLng],16,{duration:1.5});

        }, function(){
            console.log("UsuÃ¡rio negou localizaÃ§Ã£o.");
        });

    }

    setTimeout(()=>map.invalidateSize(),400);

});
</script>
</body>
</html>